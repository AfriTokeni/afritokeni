name: Security Scanning

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for known vulnerabilities
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit-results.json || true
          if [ -f audit-results.json ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)
            
            echo "**Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "**High:** $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "**Moderate:** $MODERATE" >> $GITHUB_STEP_SUMMARY
            echo "**Low:** $LOW" >> $GITHUB_STEP_SUMMARY
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "âš ï¸ Critical or high vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

  # Code scanning for security issues
  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # Secret scanning
  secret-scan:
    name: Secret & Credential Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          # Check for common secret patterns
          if grep -r -E "(api[_-]?key|secret|password|token|private[_-]?key)" --include="*.ts" --include="*.tsx" --include="*.svelte" --exclude-dir=node_modules --exclude-dir=dist .; then
            echo "âš ï¸ Potential secrets found in code. Please review." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No obvious secrets detected in code." >> $GITHUB_STEP_SUMMARY
          fi

  # License compliance
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Check Licenses
        run: |
          npx license-checker --summary > license-summary.txt || true
          echo "## ðŸ“œ License Summary" >> $GITHUB_STEP_SUMMARY
          cat license-summary.txt >> $GITHUB_STEP_SUMMARY || echo "No license information available" >> $GITHUB_STEP_SUMMARY

  # SAST (Static Application Security Testing)
  sast-scan:
    name: Static Security Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: ESLint Security Rules
        run: |
          npx eslint . \
            --ext .ts,.tsx,.svelte \
            --format json \
            --output-file eslint-results.json || true
          
          if [ -f eslint-results.json ]; then
            echo "## ðŸ” ESLint Security Analysis" >> $GITHUB_STEP_SUMMARY
            ERROR_COUNT=$(jq '[.[] | .errorCount] | add // 0' eslint-results.json)
            WARNING_COUNT=$(jq '[.[] | .warningCount] | add // 0' eslint-results.json)
            echo "**Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**Warnings:** $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

  # ICP-specific security checks
  icp-security:
    name: ICP Security Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Canister IDs
        run: |
          echo "## ðŸ” ICP Security Checks" >> $GITHUB_STEP_SUMMARY
          
          # Check for production canister IDs in code
          if grep -r "dkk74-oyaaa-aaaal-askxq-cai" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules .; then
            echo "âœ… Production satellite ID found in config" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verify juno.config.ts exists
          if [ -f "juno.config.ts" ]; then
            echo "âœ… Juno configuration file exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Juno configuration file missing!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check for Non-Custodial Architecture
        run: |
          # Verify no private key storage in code
          if grep -r -i "private.*key.*store\|store.*private.*key" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules .; then
            echo "âš ï¸ Potential private key storage detected - review required" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No private key storage patterns detected" >> $GITHUB_STEP_SUMMARY
          fi
